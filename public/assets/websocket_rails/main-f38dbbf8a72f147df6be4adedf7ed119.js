(function(){var t=function(t,n){return function(){return t.apply(n,arguments)}};this.WebSocketRails=function(){function n(n,e){this.url=n,this.use_websockets=null!=e?e:!0,this.connection_stale=t(this.connection_stale,this),this.pong=t(this.pong,this),this.supports_websockets=t(this.supports_websockets,this),this.dispatch_channel=t(this.dispatch_channel,this),this.unsubscribe=t(this.unsubscribe,this),this.subscribe_private=t(this.subscribe_private,this),this.subscribe=t(this.subscribe,this),this.dispatch=t(this.dispatch,this),this.trigger_event=t(this.trigger_event,this),this.trigger=t(this.trigger,this),this.bind=t(this.bind,this),this.connection_established=t(this.connection_established,this),this.new_message=t(this.new_message,this),this.reconnect=t(this.reconnect,this),this.callbacks={},this.channels={},this.queue={},this.connect()}return n.prototype.connect=function(){return this.state="connecting",this.supports_websockets()&&this.use_websockets?this._conn=new n.WebSocketConnection(this.url,this):this._conn=new n.HttpConnection(this.url,this),this._conn.new_message=this.new_message},n.prototype.disconnect=function(){return this._conn&&(this._conn.close(),delete this._conn._conn,delete this._conn),this.state="disconnected"},n.prototype.reconnect=function(){var t,n,e,s,i;e=null!=(s=this._conn)?s.connection_id:void 0,this.disconnect(),this.connect(),i=this.queue;for(n in i)t=i[n],t.connection_id!==e||t.is_result()||this.trigger_event(t);return this.reconnect_channels()},n.prototype.new_message=function(t){var e,s,i,o,c,r;for(c=[],s=0,i=t.length;i>s;s++)r=t[s],e=new n.Event(r),e.is_result()?(null!=(o=this.queue[e.id])&&o.run_callbacks(e.success,e.data),delete this.queue[e.id]):e.is_channel()?this.dispatch_channel(e):e.is_ping()?this.pong():this.dispatch(e),"connecting"===this.state&&"client_connected"===e.name?c.push(this.connection_established(e.data)):c.push(void 0);return c},n.prototype.connection_established=function(t){return this.state="connected",this._conn.setConnectionId(t.connection_id),this._conn.flush_queue(),null!=this.on_open?this.on_open(t):void 0},n.prototype.bind=function(t,n){var e;return null==(e=this.callbacks)[t]&&(e[t]=[]),this.callbacks[t].push(n)},n.prototype.trigger=function(t,e,s,i){var o,c;return o=new n.Event([t,e,null!=(c=this._conn)?c.connection_id:void 0],s,i),this.trigger_event(o)},n.prototype.trigger_event=function(t){var n,e;return null==(n=this.queue)[e=t.id]&&(n[e]=t),this._conn&&this._conn.trigger(t),t},n.prototype.dispatch=function(t){var n,e,s,i,o;if(null!=this.callbacks[t.name]){for(i=this.callbacks[t.name],o=[],e=0,s=i.length;s>e;e++)n=i[e],o.push(n(t.data));return o}},n.prototype.subscribe=function(t,e,s){var i;return null==this.channels[t]?(i=new n.Channel(t,this,!1,e,s),this.channels[t]=i,i):this.channels[t]},n.prototype.subscribe_private=function(t,e,s){var i;return null==this.channels[t]?(i=new n.Channel(t,this,!0,e,s),this.channels[t]=i,i):this.channels[t]},n.prototype.unsubscribe=function(t){return null!=this.channels[t]?(this.channels[t].destroy(),delete this.channels[t]):void 0},n.prototype.dispatch_channel=function(t){return null!=this.channels[t.channel]?this.channels[t.channel].dispatch(t.name,t.data):void 0},n.prototype.supports_websockets=function(){return"function"==typeof WebSocket||"object"==typeof WebSocket},n.prototype.pong=function(){var t,e;return t=new n.Event(["websocket_rails.pong",{},null!=(e=this._conn)?e.connection_id:void 0]),this._conn.trigger(t)},n.prototype.connection_stale=function(){return"connected"!==this.state},n.prototype.reconnect_channels=function(){var t,n,e,s,i;s=this.channels,i=[];for(e in s)n=s[e],t=n._callbacks,n.destroy(),delete this.channels[e],n=n.is_private?this.subscribe_private(e):this.subscribe(e),n._callbacks=t,i.push(n);return i},n}()}).call(this),function(){WebSocketRails.Event=function(){function t(t,n,e){var s;this.success_callback=n,this.failure_callback=e,this.name=t[0],s=t[1],null!=s&&(this.id=null!=s.id?s.id:65536*(1+Math.random())|0,this.channel=null!=s.channel?s.channel:void 0,this.data=null!=s.data?s.data:s,this.token=null!=s.token?s.token:void 0,this.connection_id=t[2],null!=s.success&&(this.result=!0,this.success=s.success))}return t.prototype.is_channel=function(){return null!=this.channel},t.prototype.is_result=function(){return"undefined"!=typeof this.result},t.prototype.is_ping=function(){return"websocket_rails.ping"===this.name},t.prototype.serialize=function(){return JSON.stringify([this.name,this.attributes()])},t.prototype.attributes=function(){return{id:this.id,channel:this.channel,data:this.data,token:this.token}},t.prototype.run_callbacks=function(t,n){return this.success=t,this.result=n,this.success===!0?"function"==typeof this.success_callback?this.success_callback(this.result):void 0:"function"==typeof this.failure_callback?this.failure_callback(this.result):void 0},t}()}.call(this),function(){WebSocketRails.AbstractConnection=function(){function t(t,n){this.dispatcher=n,this.message_queue=[]}return t.prototype.close=function(){},t.prototype.trigger=function(t){return"connected"!==this.dispatcher.state?this.message_queue.push(t):this.send_event(t)},t.prototype.send_event=function(t){return null!=this.connection_id?t.connection_id=this.connection_id:void 0},t.prototype.on_close=function(t){var n;return this.dispatcher&&this.dispatcher._conn===this?(n=new WebSocketRails.Event(["connection_closed",t]),this.dispatcher.state="disconnected",this.dispatcher.dispatch(n)):void 0},t.prototype.on_error=function(t){var n;return this.dispatcher&&this.dispatcher._conn===this?(n=new WebSocketRails.Event(["connection_error",t]),this.dispatcher.state="disconnected",this.dispatcher.dispatch(n)):void 0},t.prototype.on_message=function(t){return this.dispatcher&&this.dispatcher._conn===this?this.dispatcher.new_message(t):void 0},t.prototype.setConnectionId=function(t){this.connection_id=t},t.prototype.flush_queue=function(){var t,n,e,s;for(s=this.message_queue,n=0,e=s.length;e>n;n++)t=s[n],this.trigger(t);return this.message_queue=[]},t}()}.call(this),function(){var t=function(t,e){function s(){this.constructor=t}for(var i in e)n.call(e,i)&&(t[i]=e[i]);return s.prototype=e.prototype,t.prototype=new s,t.__super__=e.prototype,t},n={}.hasOwnProperty;WebSocketRails.HttpConnection=function(n){function e(t,n){var s,i;this.dispatcher=n,e.__super__.constructor.apply(this,arguments),this._url="http://"+t,this._conn=this._createXMLHttpObject(),this.last_pos=0;try{this._conn.onreadystatechange=function(t){return function(){return t._parse_stream()}}(this),this._conn.addEventListener("load",this.on_close,!1)}catch(i){s=i,this._conn.onprogress=function(t){return function(){return t._parse_stream()}}(this),this._conn.onload=this.on_close,this._conn.readyState=3}this._conn.open("GET",this._url,!0),this._conn.send()}return t(e,n),e.prototype.connection_type="http",e.prototype._httpFactories=function(){return[function(){return new XDomainRequest},function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}]},e.prototype.close=function(){return this._conn.abort()},e.prototype.send_event=function(t){return e.__super__.send_event.apply(this,arguments),this._post_data(t.serialize())},e.prototype._post_data=function(t){return $.ajax(this._url,{type:"POST",data:{client_id:this.connection_id,data:t},success:function(){}})},e.prototype._createXMLHttpObject=function(){var t,n,e,s,i,o,c;for(c=!1,e=this._httpFactories(),i=0,o=e.length;o>i;i++){s=e[i];try{c=s()}catch(n){t=n;continue}break}return c},e.prototype._parse_stream=function(){var t,n,e,s;if(3===this._conn.readyState){t=this._conn.responseText.substring(this.last_pos),this.last_pos=this._conn.responseText.length,t=t.replace(/\]\]\[\[/g,"],[");try{return s=JSON.parse(t),this.on_message(s)}catch(e){n=e}}},e}(WebSocketRails.AbstractConnection)}.call(this),function(){var t=function(t,e){function s(){this.constructor=t}for(var i in e)n.call(e,i)&&(t[i]=e[i]);return s.prototype=e.prototype,t.prototype=new s,t.__super__=e.prototype,t},n={}.hasOwnProperty;WebSocketRails.WebSocketConnection=function(n){function e(t,n){this.url=t,this.dispatcher=n,e.__super__.constructor.apply(this,arguments),this.url.match(/^wss?:\/\//)?console.log("WARNING: Using connection urls with protocol specified is depricated"):"https:"===window.location.protocol?this.url="wss://"+this.url:this.url="ws://"+this.url,this._conn=new WebSocket(this.url),this._conn.onmessage=function(t){return function(n){var e;return e=JSON.parse(n.data),t.on_message(e)}}(this),this._conn.onclose=function(t){return function(n){return t.on_close(n)}}(this),this._conn.onerror=function(t){return function(n){return t.on_error(n)}}(this)}return t(e,n),e.prototype.connection_type="websocket",e.prototype.close=function(){return this._conn.close()},e.prototype.send_event=function(t){return e.__super__.send_event.apply(this,arguments),this._conn.send(t.serialize())},e}(WebSocketRails.AbstractConnection)}.call(this),function(){var t=function(t,n){return function(){return t.apply(n,arguments)}};WebSocketRails.Channel=function(){function n(n,e,s,i,o){var c,r,h;this.name=n,this._dispatcher=e,this.is_private=null!=s?s:!1,this.on_success=i,this.on_failure=o,this._failure_launcher=t(this._failure_launcher,this),this._success_launcher=t(this._success_launcher,this),this._callbacks={},this._token=void 0,this._queue=[],r=this.is_private?"websocket_rails.subscribe_private":"websocket_rails.subscribe",this.connection_id=null!=(h=this._dispatcher._conn)?h.connection_id:void 0,c=new WebSocketRails.Event([r,{data:{channel:this.name}},this.connection_id],this._success_launcher,this._failure_launcher),this._dispatcher.trigger_event(c)}return n.prototype.destroy=function(){var t,n,e;return this.connection_id===(null!=(e=this._dispatcher._conn)?e.connection_id:void 0)&&(n="websocket_rails.unsubscribe",t=new WebSocketRails.Event([n,{data:{channel:this.name}},this.connection_id]),this._dispatcher.trigger_event(t)),this._callbacks={}},n.prototype.bind=function(t,n){var e;return null==(e=this._callbacks)[t]&&(e[t]=[]),this._callbacks[t].push(n)},n.prototype.trigger=function(t,n){var e;return e=new WebSocketRails.Event([t,{channel:this.name,data:n,token:this._token},this.connection_id]),this._token?this._dispatcher.trigger_event(e):this._queue.push(e)},n.prototype.dispatch=function(t,n){var e,s,i,o,c,r;if("websocket_rails.channel_token"===t)return this.connection_id=null!=(o=this._dispatcher._conn)?o.connection_id:void 0,this._token=n.token,this.flush_queue();if(null!=this._callbacks[t]){for(c=this._callbacks[t],r=[],s=0,i=c.length;i>s;s++)e=c[s],r.push(e(n));return r}},n.prototype._success_launcher=function(t){return null!=this.on_success?this.on_success(t):void 0},n.prototype._failure_launcher=function(t){return null!=this.on_failure?this.on_failure(t):void 0},n.prototype.flush_queue=function(){var t,n,e,s;for(s=this._queue,n=0,e=s.length;e>n;n++)t=s[n],this._dispatcher.trigger_event(t);return this._queue=[]},n}()}.call(this);