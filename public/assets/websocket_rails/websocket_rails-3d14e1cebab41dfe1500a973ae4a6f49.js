(function(){var t=function(t,n){return function(){return t.apply(n,arguments)}};this.WebSocketRails=function(){function n(n,e){this.url=n,this.use_websockets=null!=e?e:!0,this.connection_stale=t(this.connection_stale,this),this.pong=t(this.pong,this),this.supports_websockets=t(this.supports_websockets,this),this.dispatch_channel=t(this.dispatch_channel,this),this.unsubscribe=t(this.unsubscribe,this),this.subscribe_private=t(this.subscribe_private,this),this.subscribe=t(this.subscribe,this),this.dispatch=t(this.dispatch,this),this.trigger_event=t(this.trigger_event,this),this.trigger=t(this.trigger,this),this.bind=t(this.bind,this),this.connection_established=t(this.connection_established,this),this.new_message=t(this.new_message,this),this.reconnect=t(this.reconnect,this),this.callbacks={},this.channels={},this.queue={},this.connect()}return n.prototype.connect=function(){return this.state="connecting",this.supports_websockets()&&this.use_websockets?this._conn=new n.WebSocketConnection(this.url,this):this._conn=new n.HttpConnection(this.url,this),this._conn.new_message=this.new_message},n.prototype.disconnect=function(){return this._conn&&(this._conn.close(),delete this._conn._conn,delete this._conn),this.state="disconnected"},n.prototype.reconnect=function(){var t,n,e,s,i;e=null!=(s=this._conn)?s.connection_id:void 0,this.disconnect(),this.connect(),i=this.queue;for(n in i)t=i[n],t.connection_id!==e||t.is_result()||this.trigger_event(t);return this.reconnect_channels()},n.prototype.new_message=function(t){var e,s,i,c,o,h;for(o=[],s=0,i=t.length;i>s;s++)h=t[s],e=new n.Event(h),e.is_result()?(null!=(c=this.queue[e.id])&&c.run_callbacks(e.success,e.data),delete this.queue[e.id]):e.is_channel()?this.dispatch_channel(e):e.is_ping()?this.pong():this.dispatch(e),"connecting"===this.state&&"client_connected"===e.name?o.push(this.connection_established(e.data)):o.push(void 0);return o},n.prototype.connection_established=function(t){return this.state="connected",this._conn.setConnectionId(t.connection_id),this._conn.flush_queue(),null!=this.on_open?this.on_open(t):void 0},n.prototype.bind=function(t,n){var e;return null==(e=this.callbacks)[t]&&(e[t]=[]),this.callbacks[t].push(n)},n.prototype.trigger=function(t,e,s,i){var c,o;return c=new n.Event([t,e,null!=(o=this._conn)?o.connection_id:void 0],s,i),this.trigger_event(c)},n.prototype.trigger_event=function(t){var n,e;return null==(n=this.queue)[e=t.id]&&(n[e]=t),this._conn&&this._conn.trigger(t),t},n.prototype.dispatch=function(t){var n,e,s,i,c;if(null!=this.callbacks[t.name]){for(i=this.callbacks[t.name],c=[],e=0,s=i.length;s>e;e++)n=i[e],c.push(n(t.data));return c}},n.prototype.subscribe=function(t,e,s){var i;return null==this.channels[t]?(i=new n.Channel(t,this,!1,e,s),this.channels[t]=i,i):this.channels[t]},n.prototype.subscribe_private=function(t,e,s){var i;return null==this.channels[t]?(i=new n.Channel(t,this,!0,e,s),this.channels[t]=i,i):this.channels[t]},n.prototype.unsubscribe=function(t){return null!=this.channels[t]?(this.channels[t].destroy(),delete this.channels[t]):void 0},n.prototype.dispatch_channel=function(t){return null!=this.channels[t.channel]?this.channels[t.channel].dispatch(t.name,t.data):void 0},n.prototype.supports_websockets=function(){return"function"==typeof WebSocket||"object"==typeof WebSocket},n.prototype.pong=function(){var t,e;return t=new n.Event(["websocket_rails.pong",{},null!=(e=this._conn)?e.connection_id:void 0]),this._conn.trigger(t)},n.prototype.connection_stale=function(){return"connected"!==this.state},n.prototype.reconnect_channels=function(){var t,n,e,s,i;s=this.channels,i=[];for(e in s)n=s[e],t=n._callbacks,n.destroy(),delete this.channels[e],n=n.is_private?this.subscribe_private(e):this.subscribe(e),n._callbacks=t,i.push(n);return i},n}()}).call(this);